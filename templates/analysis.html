<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Session Analysis - SmartPhysio</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            text-align: center;
        }

        .header h1 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }

        .nav-buttons a {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            transition: background 0.3s;
        }

        .nav-buttons a:hover {
            background: #764ba2;
        }

        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-card h3 {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-card .value {
            font-size: 36px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-card .label {
            color: #999;
            font-size: 12px;
        }

        .chart-container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 25px;
        }

        .chart-container h2 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .sessions-list {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .session-item {
            padding: 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.3s;
        }

        .session-item:hover {
            background: #f8fafc;
        }

        .session-item:last-child {
            border-bottom: none;
        }

        .session-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .session-title {
            font-weight: bold;
            color: #333;
            font-size: 18px;
        }

        .session-date {
            color: #999;
            font-size: 14px;
        }

        .session-stats {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }

        .session-stat {
            display: flex;
            flex-direction: column;
        }

        .session-stat .label {
            color: #666;
            font-size: 12px;
            margin-bottom: 3px;
        }

        .session-stat .value {
            font-weight: bold;
            color: #667eea;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-excellent {
            background: #d1fae5;
            color: #059669;
        }

        .badge-good {
            background: #dbeafe;
            color: #2563eb;
        }

        .badge-fair {
            background: #fef3c7;
            color: #d97706;
        }

        .badge-poor {
            background: #fee2e2;
            color: #dc2626;
        }

        .session-detail {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-top: 25px;
            display: none;
        }

        .session-detail.active {
            display: block;
        }

        .reps-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }

        .rep-card {
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s;
        }

        .rep-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .rep-card.excellent {
            border-color: #10b981;
            background: #d1fae5;
        }

        .rep-card.good {
            border-color: #3b82f6;
            background: #dbeafe;
        }

        .rep-card.fair {
            border-color: #f59e0b;
            background: #fef3c7;
        }

        .rep-card.poor {
            border-color: #ef4444;
            background: #fee2e2;
        }

        .rep-number {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .rep-score {
            font-size: 24px;
            font-weight: bold;
        }

        .filter-bar {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 25px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-bar select {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }

        .filter-bar button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: #667eea;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .filter-bar button:hover {
            background: #5568d3;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: white;
            font-size: 18px;
        }

        .empty-state {
            text-align: center;
            padding: 50px;
            color: #999;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #666;
        }

        @media (max-width: 768px) {
            .stats-overview {
                grid-template-columns: 1fr;
            }

            .session-stats {
                flex-direction: column;
                gap: 10px;
            }

            .reps-grid {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ“Š Session Analysis & History</h1>
            <p>Detailed insights into your physiotherapy progress</p>
            <div class="nav-buttons">
                <a href="/">New Session</a>
                <a href="/analysis">Refresh Analysis</a>
            </div>
        </div>

        <div class="filter-bar">
            <label>Filter by Exercise:</label>
            <select id="exerciseFilter" onchange="filterSessions()">
                <option value="all">All Exercises</option>
                <option value="squat">Squats</option>
                <option value="abduction">Shoulder Abduction</option>
                <option value="elbow">Elbow Flexion</option>
                <option value="hipflex">Hip Flexion</option>
                <option value="wristext">Wrist Extension</option>
            </select>
            <button onclick="loadData()">Refresh Data</button>
        </div>

        <div id="loadingIndicator" class="loading">Loading analysis data...</div>

        <div id="statsContainer" style="display: none;">
            <div class="stats-overview">
                <div class="stat-card">
                    <h3>Total Sessions</h3>
                    <div class="value" id="totalSessions">0</div>
                    <div class="label">Completed</div>
                </div>
                <div class="stat-card">
                    <h3>Total Reps</h3>
                    <div class="value" id="totalReps">0</div>
                    <div class="label">All Exercises</div>
                </div>
                <div class="stat-card">
                    <h3>Overall Average</h3>
                    <div class="value" id="overallAvg">0</div>
                    <div class="label">Score</div>
                </div>
                <div class="stat-card">
                    <h3>Best Session</h3>
                    <div class="value" id="bestScore">0</div>
                    <div class="label">Score</div>
                </div>
            </div>

            <div class="chart-container">
                <h2>Performance Trends</h2>
                <canvas id="performanceChart"></canvas>
            </div>

            <div class="chart-container">
                <h2>Exercise Distribution</h2>
                <canvas id="exerciseChart"></canvas>
            </div>

            <div class="sessions-list">
                <h2 style="margin-bottom: 20px;">Session History</h2>
                <div id="sessionsList"></div>
            </div>

            <div id="sessionDetail" class="session-detail">
                <h2>Session Details</h2>
                <div id="detailContent"></div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:5000/api';
        let allSessions = [];
        let allStats = {};

        async function loadData() {
            try {
                document.getElementById('loadingIndicator').style.display = 'block';
                document.getElementById('statsContainer').style.display = 'none';

                // Fetch overall stats
                const statsResponse = await fetch(`${API_URL}/stats`);
                allStats = await statsResponse.json();

                // Fetch all sessions
                const sessionsResponse = await fetch(`${API_URL}/sessions`);
                const sessionsData = await sessionsResponse.json();
                allSessions = sessionsData.sessions;

                displayStats();
                displaySessions();
                createCharts();

                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('statsContainer').style.display = 'block';

            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loadingIndicator').textContent = 
                    'Error loading data. Make sure the Flask server is running.';
            }
        }

        function displayStats() {
            document.getElementById('totalSessions').textContent = allStats.total_sessions || 0;
            document.getElementById('totalReps').textContent = allStats.total_reps || 0;
            document.getElementById('overallAvg').textContent = 
                (allStats.overall_average || 0).toFixed(1);

            const bestSession = allSessions
                .filter(s => s.status === 'completed')
                .sort((a, b) => b.average_score - a.average_score)[0];
            
            document.getElementById('bestScore').textContent = 
                bestSession ? bestSession.average_score.toFixed(1) : '0';
        }

        function displaySessions(filter = 'all') {
            const sessionsList = document.getElementById('sessionsList');
            
            let filteredSessions = allSessions.filter(s => s.status === 'completed');
            
            if (filter !== 'all') {
                filteredSessions = filteredSessions.filter(s => s.exercise_type === filter);
            }

            if (filteredSessions.length === 0) {
                sessionsList.innerHTML = `
                    <div class="empty-state">
                        <h3>No sessions found</h3>
                        <p>Start a new session to see your progress here!</p>
                    </div>
                `;
                return;
            }

            sessionsList.innerHTML = filteredSessions.map(session => {
                const date = new Date(session.start_time);
                const badge = getScoreBadge(session.average_score);
                const duration = formatDuration(session.duration_seconds);

                return `
                    <div class="session-item" onclick="loadSessionDetail(${session.id})">
                        <div class="session-header">
                            <div class="session-title">
                                ${formatExerciseName(session.exercise_type)} 
                                <span class="badge badge-${badge}">${session.average_score.toFixed(1)}</span>
                            </div>
                            <div class="session-date">${date.toLocaleString()}</div>
                        </div>
                        <div class="session-stats">
                            <div class="session-stat">
                                <span class="label">Reps</span>
                                <span class="value">${session.total_reps}</span>
                            </div>
                            <div class="session-stat">
                                <span class="label">Duration</span>
                                <span class="value">${duration}</span>
                            </div>
                            <div class="session-stat">
                                <span class="label">Mode</span>
                                <span class="value">${session.session_mode}</span>
                            </div>
                            <div class="session-stat">
                                <span class="label">Avg Score</span>
                                <span class="value">${session.average_score.toFixed(1)}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function loadSessionDetail(sessionId) {
            try {
                const response = await fetch(`${API_URL}/sessions/${sessionId}`);
                const session = await response.json();

                const detailContainer = document.getElementById('sessionDetail');
                const detailContent = document.getElementById('detailContent');

                const repsHtml = session.reps.map((rep, index) => {
                    const scoreClass = getScoreBadge(rep.score);
                    return `
                        <div class="rep-card ${scoreClass}">
                            <div class="rep-number">Rep ${rep.rep_number}</div>
                            <div class="rep-score">${rep.score.toFixed(0)}</div>
                            <div style="font-size: 10px; color: #666; margin-top: 5px;">
                                ${rep.tracked_side}
                            </div>
                        </div>
                    `;
                }).join('');

                detailContent.innerHTML = `
                    <h3>${formatExerciseName(session.exercise_type)} - ${new Date(session.start_time).toLocaleString()}</h3>
                    <p style="margin: 15px 0; color: #666;">
                        <strong>Mode:</strong> ${session.session_mode} | 
                        <strong>Duration:</strong> ${formatDuration(session.duration_seconds)} | 
                        <strong>Total Reps:</strong> ${session.total_reps}
                    </p>
                    <h4 style="margin-top: 25px;">Rep Breakdown</h4>
                    <div class="reps-grid">
                        ${repsHtml || '<p>No reps recorded</p>'}
                    </div>
                `;

                detailContainer.classList.add('active');
                detailContainer.scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                console.error('Error loading session detail:', error);
            }
        }

        function createCharts() {
            // Performance Trends Chart
            const completedSessions = allSessions
                .filter(s => s.status === 'completed')
                .sort((a, b) => new Date(a.start_time) - new Date(b.start_time))
                .slice(-10); // Last 10 sessions

            const perfCtx = document.getElementById('performanceChart').getContext('2d');
            new Chart(perfCtx, {
                type: 'line',
                data: {
                    labels: completedSessions.map((s, i) => `Session ${i + 1}`),
                    datasets: [{
                        label: 'Average Score',
                        data: completedSessions.map(s => s.average_score),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Total Reps',
                        data: completedSessions.map(s => s.total_reps),
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: true,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Score'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Reps'
                            },
                            grid: {
                                drawOnChartArea: false,
                            }
                        }
                    }
                }
            });

            // Exercise Distribution Chart
            const exCtx = document.getElementById('exerciseChart').getContext('2d');
            const exerciseData = allStats.exercise_breakdown || [];
            
            new Chart(exCtx, {
                type: 'bar',
                data: {
                    labels: exerciseData.map(e => formatExerciseName(e.exercise_type)),
                    datasets: [{
                        label: 'Sessions',
                        data: exerciseData.map(e => e.session_count),
                        backgroundColor: '#667eea'
                    }, {
                        label: 'Total Reps',
                        data: exerciseData.map(e => e.total_reps),
                        backgroundColor: '#10b981'
                    }, {
                        label: 'Avg Score',
                        data: exerciseData.map(e => e.avg_score),
                        backgroundColor: '#f59e0b'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function filterSessions() {
            const filter = document.getElementById('exerciseFilter').value;
            displaySessions(filter);
        }

        function getScoreBadge(score) {
            if (score >= 95) return 'excellent';
            if (score >= 85) return 'good';
            if (score >= 75) return 'fair';
            return 'poor';
        }

        function formatExerciseName(type) {
            const names = {
                'squat': 'Squats',
                'abduction': 'Shoulder Abduction',
                'elbow': 'Elbow Flexion',
                'hipflex': 'Hip Flexion',
                'wristext': 'Wrist Extension'
            };
            return names[type] || type;
        }

        function formatDuration(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}m ${secs}s`;
        }

        // Check for session parameter in URL
        const urlParams = new URLSearchParams(window.location.search);
        const sessionId = urlParams.get('session');

        // Load data on page load
        loadData().then(() => {
            if (sessionId) {
                loadSessionDetail(parseInt(sessionId));
            }
        });
    </script>
</body>
</html>
